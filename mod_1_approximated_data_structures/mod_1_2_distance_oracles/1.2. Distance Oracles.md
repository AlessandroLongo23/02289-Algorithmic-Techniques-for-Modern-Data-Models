## The problem
### The shortest path problem
This is the shortest path problem:
![[The shortest path problem.png]]
### Our problem
For an edge-weighted graph $G=(V,E)$, let $\delta(s,t)$ be the shortest path distance in $G$ from the source node $s\in V$ to the target node $t\in V$.
We want a data structure for $G$ that can answer queries of the form: "What is $\delta(s,t)$?" for any $s,t\in V$.
### Approximate distances
Let $n=|V|$.
It can be shown that in the worst case, $\Theta(n^2)$ space is the best we can hope for if we want exact distances.
We therefore consider approximate shortest path distances.
### Approximate distance oracle
For any $u,v\in V$ we define $\tilde\delta(u,v)$ as an estimate of $\delta(u,v)$ of stretch $t\ge 1$ if:
$$\delta(u,v)\le\tilde\delta(u,v)\le t\cdot\delta(u,v)$$
$t$-approximate distance oracle answers queries with estimates of stretch $t$, and should preferably use a small amount of space.
From now on, we consider only undirected edge-weighted graph since for any stretch $t$, $\Theta(n^2)$ space is the best we can hope for for directed graphs.
### A simple approximate distance oracle
Start with the vertices, we assume here that the graph is complete, i.e., $(u,v)\in E\quad\forall u,v\in V$
![[ado vertices.png]]
Sample each vertex independently with some probability $p$:
![[ado sample.png]]
Now, for each vertex (we take the green one as example here):
![[ado point.png]]
consider all vertices closer than the nearest sampled vertex:
![[ado closer.png]]
Compute and store distances to these vertices:
![[ado distances.png]]
and to all sampled vertices (red):
![[ado distance sampled.png]]
Also, store the nearest sampled vertex:
![[ado nearest sampled.png]]
Now, to answer a query for the distance between $u$ and $v$, we have to cases:
#### Case 1
If $v$ is closer to $u$ than the nearest sampled vertex:
![[ado u and v near.png]]
then it's a simple look-up.
![[ado lookup.png]]
#### Case 2
if $v$ is further than the nearest sampled vertex:
![[ado u and v far.png]]
then we stored the nearest sample to $u$ and the distance between them:
![[ado distance u-sample.png]]
but also the distance between $v$ and this sampled vertex. Thus, the oracle returns the sum of these two distances:
![[ado distance v-sample.png]]
It can be proven that this estimate has stretch $3$.
- - -
## Analyzing space of the approximate distance oracle
Letting $S$ be the sampled vertices, the oracle stores:
- $\delta(s,v)$ for all $s\in S$ and all $v\in V$
- $\delta(u,v)$ for all $u\in V$ and all $v$ closer to $u$ than $u$'s nearest vertex in $S$

We will now analyze these independently:
### Part 1
Since each $v\in V$ is sampled independently with probability $p$:
$$\mathbb E[|S|]=np$$
The expected space for the stored distances between $s\in S$ and $v\in V$ is:
$$\mathbb E[|V|\cdot|S|]=\mathbb E[n|S|]=n\mathbb E[|S|]=O(n^2p)$$
### Part 2
For $u\in V$, consider all $v\in V$ in non-decreasing distance to $u$:
$$v_1,\ldots,v_n$$where $v_1=u$.
Let $l$ be the smallest index such that $v_l\in S$, assuming that $l$ exists.
![[ado part II.png]]
The number of distances stored from $u$ is $l-1<l$
We need to calculate the expected space, which is less than $\mathbb E[l]$.
Consider a coin with probability $p$ of heads.
Finding $l$ corresponds to flipping the coin for $v_1$, then for $v_2$, etc, until it lands on heads and count the total number of tosses.
Thus, $l$ follows the geometric distribution with parameter $p$, so $\mathbb E[l]=\dfrac1p$
In conclusion, the expected space needed to store these distances is:
$$O(n\mathbb E[l])=O\left(\dfrac np\right)$$
### Putting it together
So the total space of the oracle requires an expected space of:
$$O\left(n^2p+\dfrac np\right)$$
To minimize this, we can solve for $p$ and obtain:
$$n^2p=\dfrac np\iff p^2=\dfrac1 n\iff p=\dfrac1{\sqrt n}$$
This optimal choice of $p$ gives space $O(n^{3/2})$.
- - -
## The Thorup-Zwick Oracle
### Introduction
What we described until now is a $3$-approximate distance oracle, requiring $O(n^{3/2})$ space and $O(1)$ query time.
In 2001, Thorup and Zwick showed that for any $k\in\mathbb N$, there is an oracle with:
- $O(kn^{1+1/k})$ space
- $O(k)$ query time
- stretch $2k-1$
- $O(kmn^{1/k})$ construction time, which we will not cover

```ad-Esempio
title: Examples
- $k=1\implies O(n^2)$ space and stretch $1$
- $k=2\implies O(n^{3/2})$ space and stretch $3$
- $k=3\implies O(n^{4/3})$ space and stretch $5$
- $\ldots$
```
The trade-off between space and stretch is conjectured to be essentially optimal.
We will now present and analyze this oracle.
### Description
Define sampled subsets $A_0,\ldots,A_k$ of $V$ as follows:
- $A_0=V$
- for $i=1,\ldots,k-1$, we obtain $A_i$ from $A_{i-1}$ by sampling each of its vertices independently with some probability $p$
- $A_k=\emptyset$

```ad-Esempio
title: Example
Starting set $A_0=V$, in black:
![[tzado example 1.png]]

After the first sampling we get $A_1\subseteq A_0$, in blue:
![[tzado example 2.png]]

With the second sampling we get $A_2\subseteq A_1$, in white
![[tzado example 3.png]]
```
#### Distance to a set
For $u\in V$ and $i=0,\ldots, k$, we define:
$$\delta(u,A_i)=\min_{v\in A_i}\delta(u,v)$$
where $\delta(u,A_i)=\infty$ if $A_i=\emptyset$
If $A_i\ne\emptyset$, let $p_i(u)$ be a closest vertex to $u$ in $A_i$. Note that:
$$\delta(u,p_i(u))=\delta(u,A_i)$$
![[tzado distance to set.png]]
#### Bunches
Bunch $B(u)$ is defined as the set of vertices in $A_i$ that are closer to $u$ than $\delta(u,A_{i+1})$, with $i=0,\ldots,k-1$.
```ad-Esempio
title: Bunch example
![[tzado bunch example.png]]
```
Observe $A_k=\emptyset\implies\delta(u,A_k)=\infty\implies A_{k+1}\subseteq B(u)$.
#### Information stored by the oracle
For each $u\in V$, the oracle stores:
- $B(u)$ as an hash table
- $p_i(u)$ for $i=1,\ldots,k-1$
- $\delta(u,v)$ for each $v\in B(u)$

![[tzado information.png]]
This matches what we store for our $3$-approximate distance oracle where $k=2$
The space of the oracle is bounded by the total space for all bunches.
### Space complexity
We will show that for each $u\in V$:
$$\mathbb E[|B(u)|]=O\left(\dfrac kp+np^{k-1}\right)$$
Picking $p=n^{-1/k}$ then gives:
$$\begin{align}
\mathbb E[|B(u)|]&=O\left(\dfrac k{n^{-1/k}}+n\cdot(n^{-1/k})^{k-1})\right)=\\
&=O(kn^{1/k}+n^{1/k})=\\
&=O(kn^{1/k})
\end{align}$$
By linearity of expectation, the total expected space is:
$$\mathbb E\left[\sum_{u\in V}|B(u)|\right]=\sum_{u\in V}\mathbb E[|B(u)|]=O(kn^{1+1/k})$$
To show that:
$$\mathbb E[|B(u)|]=O\left(\dfrac k{n^{-1/k}}+n\cdot(n^{-1/k})^{k-1})\right)$$
is true in the first place, recall that $p$ is the probability that a vertex in $A_i$ is sampled and included in $A_{i+1}$, for $i=0,\ldots,k-2$
The analysis for $3$-approximate oracle is that the expected number of vertices in $A_0$ closer to $u$ than $\delta(u,A_i)$ is $O\left(\dfrac1p\right)$
Generalizing to $i=0,\ldots,k-2$, the expected number of vertices in $A_i$ closer to $u$ than $\delta(u,p_{i+1}(u))$ is $O\left(\dfrac1p\right)$.
This is a total of:
$$(k-1)O\left(\dfrac1p\right)=O\left(\dfrac kp\right)$$
Bunch $B(u)$ also contains $A_{k-1}$. Since a vertex of $V$ is in $A_{k-1}$ if and only if it is sampled independently $k-1$ times in a row with probability $p$, the expected size is:
$$\mathbb E[|A_{k-1}|]=np^{k-1}$$
Thus:
$$\mathbb E[|B(u)|]=O\left(\dfrac kp+np^{k-1}\right)$$
### Queries
To answer a query, we propose the following algorithm, which returns the estimate $\tilde\delta(u,v)$:
```
proc dist(u, v):
	w = u
	i = 0
	while w not in B(v):
		i++
		(u, v) = (v, u)
		w = p_i(u)
	
	return d(w, u) + d(w, v)
```
The algorithm must terminate no later than at index $i=k-1$ because, regardless of the choice of $u$ and $v$, they all store all points from $A_{k-1}$.
Also, at the end, both distances $\delta(w,u)$ and $\delta(w,v)$ are stored by the data structure, because the last value of $w$ is $p_i(u)$ which is stored in $B(u)$, but also in $B(v)$, since it entered the while body.
### Bounding the stretch
We will show that for each even $i$ that satisfies the condition $w\notin B(v)$ in the while loop:
$$\delta(v,p_{i+1}(v))\le\delta(u,p_i(u))+\delta(u,v)$$
Which, by a symmetric argument, will automatically hold for each odd $i$ satisfying the condition in the while loop. 
![[tzado bounding stretch diagram.png]]
Every gap in the figure satisfying the condition is thus $\le\delta(u,v)$.
Since $B(v)$ contains all vertices of $A_i$ closer to $v$ than $p_{i+1}(v)$:
$$\delta(v,p_{i+1}(v))\le\delta(v,p_i(u))$$
![[tzado bounding stretch.png]]
By triangle inequality:
$$\delta(v,p_i(u))\le\delta(v,u)+\delta(u,p_i(u))$$
Combining these inequalities gives the desired:
$$\delta(v,p_{i+1}(v))\le\delta(u,p_i(u))+\delta(u,v)$$
If, e.g., $w=p_i(u)$ at termination, we have $i\le k-1$, and thus:
$$\begin{align}
\overbrace{\delta(w,v)+\delta(w,v)}^{\text{return value}}&\le\delta(w,u)+\delta(w,u)+\delta(u,v)=\\
&=2\delta(w,u)+\delta(u,v)\le\\
&\le2i\delta(u,v)+\delta(u,v)\le\\
&\le2(k-1)\delta(u,v)+\delta(u,v)=\\
&=(2k-1)\delta(u,v)
\end{align}$$
where the first is a triangle inequality, from line 2 to 3 we used the gap bounds, and form 3 to 4 we used the fact that $i\le k-1$.
- - -
## Summary and conclusion
We have proved that the Thorup-Zwick distance oracle has:
- $2k-1$ stretch
- $O(k)$ query time
- $O(kn^{1+1/k})$ space

The space bound is measured in words, not in bits.
For stretch $2k-1$ there is a conjectured lower bound of $\Omega(n^{1+1/k})$ bits, called Girth conjecture.
In practice, there are much better data structures for road networks, where distances returned are exact, i.e., stretch $1$.
These data structure leverage special properties of road networks that do not generalize to arbitrary graphs.
- - -
